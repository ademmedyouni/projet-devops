pipeline {
    agent any

    tools {
        jdk 'JDK21'
        maven 'Maven3'
    }

    environment {
        SONAR_HOST_URL   = 'http://localhost:9000'
        NEXUS_URL        = 'http://localhost:8081'
        NEXUS_REPOSITORY = 'maven-releases'

        DOCKER_IMAGE = 'ademm123/eventsproject'
        DOCKER_TAG   = "${BUILD_NUMBER}"
        RELEASE_VERSION = "1.0.${BUILD_NUMBER}"
    }

    stages {

        stage('Env Info') {
            steps {
                sh 'java -version'
                sh 'mvn -v'
            }
        }

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/ademmedyouni/projet-devops.git'
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean compile -B'
            }
        }
        stage('Fix Maven Cache') {
    steps {
        sh '''
            echo "Cleaning corrupted Maven artifacts..."
            find /var/lib/jenkins/.m2/repository -name "*.pom" -size 0 -delete || true
            find /var/lib/jenkins/.m2/repository -name "*.jar" -size 0 -delete || true
        '''
    }
}


        stage('Tests + JaCoCo') {
            steps {
                sh 'mvn test -B'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                    sh 'mvn jacoco:report || true'
                    archiveArtifacts artifacts: 'target/site/jacoco/**/*', allowEmptyArchive: true
                }
            }
        }

stage('SonarQube Analysis') {
    steps {
        withSonarQubeEnv('sonarqube') {
            withCredentials([string(credentialsId: 'SonarQube_jenkins', variable: 'SONAR_TOKEN')]) {
                sh """
                    echo "Starting SonarQube analysis..."
                    mvn sonar:sonar \
                        -Dsonar.projectKey=eventsproject \
                        -Dsonar.host.url=${SONAR_HOST_URL} \
                        -Dsonar.login=${SONAR_TOKEN} \
                        -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                        -B
                """
            }
        }
    }
}

stage('Wait for Analysis Completion') {
    steps {
        echo "Waiting 30 seconds for SonarQube analysis to complete..."
        sleep 30
    }
}

stage('Quality Gate') {
    steps {
        timeout(time: 15, unit: 'MINUTES') {
            script {
                echo "Checking Quality Gate..."
                def qg = waitForQualityGate abortPipeline: true
                echo "Quality Gate status: ${qg.status}"
            }
        }
    }
}


        stage('Package') {
            steps {
                sh 'mvn package -DskipTests -B'
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
            }
        }

        stage('Deploy to Nexus') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'nexus-credentials',
                    usernameVariable: 'NEXUS_USER',
                    passwordVariable: 'NEXUS_PASS'
                )]) {
                    sh '''
                    GROUP_ID=$(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout)
                    ARTIFACT_ID=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
                    PACKAGING=$(mvn help:evaluate -Dexpression=project.packaging -q -DforceStdout)

                    JAR=$(ls target/*.jar | grep -v original | head -n1)
                    GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')

                    curl -u "$NEXUS_USER:$NEXUS_PASS" \
                        --upload-file "$JAR" \
                        "$NEXUS_URL/repository/$NEXUS_REPOSITORY/$GROUP_PATH/$ARTIFACT_ID/$RELEASE_VERSION/$ARTIFACT_ID-$RELEASE_VERSION.$PACKAGING"
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                sh """
                    docker build -t $DOCKER_IMAGE:$DOCKER_TAG .
                    docker tag $DOCKER_IMAGE:$DOCKER_TAG $DOCKER_IMAGE:latest
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-creds',
                    usernameVariable: 'DH_USER',
                    passwordVariable: 'DH_PASS'
                )]) {
                    sh """
                        echo "$DH_PASS" | docker login -u "$DH_USER" --password-stdin
                        docker push $DOCKER_IMAGE:$DOCKER_TAG
                        docker push $DOCKER_IMAGE:latest
                        docker logout
                    """
                }
            }
        }

stage('Deploy') { 
    steps { sh ''' echo "Stopping previous stack..." 
    docker compose down --remove-orphans || true 
    echo "Starting new stack..." 
    docker compose up -d 
    echo "Waiting 20s..." 
    sleep 20 
    echo "Containers status:" 
    docker compose ps ''' } }


    }

    post {
        success {
            echo "✅ Pipeline succeeded — application deployed"
        }
        failure {
            echo "❌ Pipeline failed — check Jenkins logs"
        }
        always {
            cleanWs()
        }
    }
}
